<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dispatch - Design B - Left Panel + Quick View Card</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; background: #f3f4f6; display: flex; flex-direction: column; }
  .banner { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: #fef3c7; color: #92400e; padding: 5px 16px; border-radius: 0 0 6px 6px; font-size: 11px; font-weight: 600; z-index: 100; box-shadow: 0 2px 6px rgba(0,0,0,0.1); white-space: nowrap; }

  /* ── Header ── */
  .header { height: 44px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 12px; gap: 8px; position: relative; z-index: 30; flex-shrink: 0; }
  .header h1 { font-size: 14px; font-weight: 700; color: #111827; white-space: nowrap; }
  .header .sep { width: 1px; height: 20px; background: #e5e7eb; }
  .date-nav { display: flex; align-items: center; gap: 4px; }
  .date-nav button { background: none; border: none; cursor: pointer; font-size: 14px; color: #6b7280; padding: 2px 6px; border-radius: 4px; }
  .date-nav button:hover { background: #f3f4f6; }
  .date-nav span { font-size: 13px; font-weight: 500; color: #374151; }
  .date-nav .day-badge { font-size: 11px; background: #e5e7eb; color: #374151; padding: 1px 8px; border-radius: 4px; font-weight: 500; }
  .stat-dots { display: flex; gap: 4px; align-items: center; }
  .stat-dot { display: flex; align-items: center; gap: 3px; font-size: 11px; font-weight: 600; color: #374151; padding: 2px 6px; border-radius: 4px; cursor: pointer; }
  .stat-dot:hover { background: #f3f4f6; }
  .stat-dot .dot { width: 6px; height: 6px; border-radius: 50%; }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 6px; }
  .view-dropdown { display: flex; align-items: center; gap: 4px; padding: 4px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 12px; font-weight: 500; background: #fff; cursor: pointer; color: #374151; }
  .icon-btn { width: 32px; height: 32px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #6b7280; }
  .icon-btn.active { border-color: #3b82f6; background: #eff6ff; color: #2563eb; }
  .add-btn { height: 32px; padding: 0 10px; border: none; border-radius: 6px; background: #2563eb; color: #fff; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; }

  /* ── Timeline ── */
  .timeline-area { height: calc(50vh - 22px); overflow: hidden; background: #fff; flex-shrink: 0; }
  .tech-row { display: flex; align-items: center; height: 56px; padding: 0 10px; gap: 8px; border-bottom: 1px solid #f3f4f6; }
  .tech-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 12px; font-weight: 700; flex-shrink: 0; }
  .tech-info { flex: 1; min-width: 0; }
  .tech-name { font-size: 13px; font-weight: 600; color: #111827; }
  .tech-meta { font-size: 11px; color: #9ca3af; }
  .time-headers { display: flex; height: 28px; border-bottom: 1px solid #e5e7eb; background: #fafafa; }
  .time-header { min-width: 80px; font-size: 10px; color: #9ca3af; font-weight: 500; display: flex; align-items: center; padding-left: 6px; border-right: 1px solid #f3f4f6; }
  .grid-row { height: 56px; border-bottom: 1px solid #f3f4f6; position: relative; }
  .job-block { height: 40px; border-radius: 6px; padding: 4px 8px; font-size: 11px; color: #fff; font-weight: 500; display: flex; flex-direction: column; justify-content: center; cursor: pointer; position: absolute; top: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.15s ease, box-shadow 0.15s ease; }
  .job-block:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
  .job-block.selected { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.25); outline: 2px solid #fff; }
  .job-block .job-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .job-block .job-sub { font-size: 10px; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .unassigned-row { display: flex; height: 40px; background: #fef2f2; border-bottom: 1px solid #fecaca; align-items: center; padding: 0 10px; gap: 6px; }
  .unassigned-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
  .unassigned-label { font-size: 12px; font-weight: 600; color: #dc2626; }
  .unassigned-count { font-size: 11px; color: #f87171; }
  .unassigned-chip { padding: 4px 10px; background: #fff; border: 1px solid #fecaca; border-radius: 6px; font-size: 11px; font-weight: 500; color: #374151; white-space: nowrap; cursor: pointer; }
  .unassigned-chip:hover { background: #fef2f2; }
  .unassigned-chip.selected { background: #fee2e2; border-color: #ef4444; }
  .status-legend { height: 28px; background: #fafafa; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 14px; gap: 16px; flex-shrink: 0; }
  .legend-item { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #6b7280; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }
  .legend-label { font-size: 10px; font-weight: 600; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; }
  .drawer-handle { height: 28px; background: #f9fafb; border-top: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: ns-resize; flex-shrink: 0; }
  .handle-bar { width: 40px; height: 4px; background: #d1d5db; border-radius: 2px; }
  .handle-label { font-size: 11px; color: #6b7280; font-weight: 500; }

  /* ── Map Area ── */
  .map-drawer { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .map-content { flex: 1; display: flex; overflow: hidden; position: relative; }
  .map-canvas { flex: 1; position: relative; background: linear-gradient(135deg, #dce8d0 0%, #e2dcc8 30%, #ddd8c6 50%, #d5ddd0 70%, #e0e4d6 100%); }
  .area-label { position: absolute; font-weight: 500; letter-spacing: 1.5px; color: #777; font-size: 11px; }

  /* ── Map Pins ── */
  .map-pin { position: absolute; cursor: pointer; transition: transform 0.2s ease; z-index: 2; }
  .map-pin:hover { transform: scale(1.15); z-index: 5; }
  .map-pin.selected { transform: scale(1.25); z-index: 10; }
  .pin-svg { width: 28px; height: 34px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.25)); }
  .pin-num { position: absolute; top: 4px; left: 50%; transform: translateX(-50%); font-size: 10px; font-weight: 700; color: #fff; }
  .pin-tip { position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.15s; }
  .map-pin:hover .pin-tip { opacity: 1; }
  .map-pin.selected .pin-tip { opacity: 0; }
  .map-pin.selected::after { content: ''; position: absolute; top: -4px; left: -4px; width: 36px; height: 36px; border: 2px solid currentColor; border-radius: 50%; animation: pulse 1.5s ease-out infinite; }
  @keyframes pulse { 0% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1.6); opacity: 0; } }

  /* ── Quick View Popup Card ── */
  .popup-card { position: absolute; width: 310px; background: #fff; border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.22), 0 2px 8px rgba(0,0,0,0.1); z-index: 50; opacity: 0; transform: translateY(8px) scale(0.96); pointer-events: none; transition: opacity 0.2s ease, transform 0.2s ease; overflow: hidden; }
  .popup-card.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
  .popup-arrow { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 9px solid transparent; border-right: 9px solid transparent; border-top: 9px solid #fff; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.08)); }
  .popup-arrow.top { bottom: auto; top: -8px; border-top: none; border-bottom: 9px solid #fff; filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.08)); }

  .popup-photo-strip { display: flex; height: 72px; gap: 2px; overflow: hidden; background: #f3f4f6; }
  .popup-photo-strip img { width: 33.34%; height: 100%; object-fit: cover; transition: opacity 0.15s; }
  .popup-photo-strip img:hover { opacity: 0.85; }

  .popup-body { padding: 10px 14px 8px; }
  .popup-title-row { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
  .popup-title { font-size: 14px; font-weight: 600; color: #111827; line-height: 1.3; }
  .popup-priority { font-size: 9px; font-weight: 600; padding: 2px 8px; border-radius: 99px; white-space: nowrap; flex-shrink: 0; }
  .popup-customer { font-size: 12px; color: #6b7280; margin-top: 2px; }
  .popup-meta { display: flex; gap: 10px; margin-top: 7px; font-size: 11px; color: #4b5563; }
  .popup-meta-item { display: flex; align-items: center; gap: 4px; }
  .popup-meta-item svg { width: 12px; height: 12px; color: #9ca3af; flex-shrink: 0; }
  .popup-tags { display: flex; gap: 5px; margin-top: 7px; }
  .popup-tag { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 99px; }

  .popup-actions { display: flex; gap: 5px; padding: 8px 14px 10px; border-top: 1px solid #f3f4f6; }
  .popup-action { flex: 1; padding: 7px 6px; font-size: 11px; font-weight: 600; border-radius: 6px; cursor: pointer; border: none; text-align: center; transition: background 0.15s, transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 4px; }
  .popup-action:active { transform: scale(0.97); }
  .popup-action svg { width: 13px; height: 13px; }
  .action-details { background: #2563eb; color: #fff; }
  .action-details:hover { background: #1d4ed8; }
  .action-nav { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
  .action-nav:hover { background: #dcfce7; }
  .action-call { background: #f0f9ff; color: #2563eb; border: 1px solid #bfdbfe; }
  .action-call:hover { background: #dbeafe; }

  /* ── Left Detail Panel ── */
  .left-panel { position: absolute; left: 0; top: 0; bottom: 0; width: 380px; background: #fff; border-right: 1px solid #e5e7eb; transform: translateX(-100%); transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); z-index: 20; display: flex; flex-direction: column; box-shadow: 4px 0 20px rgba(0,0,0,0.1); }
  .left-panel.open { transform: translateX(0); }
  .lp-header { padding: 14px 16px 10px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: flex-start; }
  .lp-header-content { flex: 1; min-width: 0; }
  .lp-header h3 { font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 2px; }
  .lp-header p { font-size: 12px; color: #6b7280; line-height: 1.4; }
  .lp-close { background: none; border: none; cursor: pointer; width: 28px; height: 28px; border-radius: 6px; color: #9ca3af; font-size: 16px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: 8px; }
  .lp-close:hover { background: #f3f4f6; color: #374151; }
  .lp-carousel { border-bottom: 1px solid #e5e7eb; background: #f9fafb; padding: 8px 0; overflow: hidden; }
  .lp-carousel-inner { display: flex; gap: 6px; padding: 0 16px; overflow-x: auto; scroll-behavior: smooth; scrollbar-width: none; }
  .lp-carousel-inner::-webkit-scrollbar { display: none; }
  .lp-carousel-thumb { width: 90px; height: 68px; border-radius: 6px; overflow: hidden; cursor: pointer; flex-shrink: 0; position: relative; border: 2px solid transparent; transition: border-color 0.15s, transform 0.15s; }
  .lp-carousel-thumb:hover { border-color: #2563eb; transform: scale(1.03); }
  .lp-carousel-thumb img { width: 100%; height: 100%; object-fit: cover; }
  .lp-carousel-thumb .carousel-zoom { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.15s; }
  .lp-carousel-thumb:hover .carousel-zoom { opacity: 1; }
  .carousel-zoom svg { width: 18px; height: 18px; color: #fff; }
  .lp-carousel-label { font-size: 10px; color: #9ca3af; padding: 4px 16px 0; display: flex; align-items: center; gap: 4px; }
  .lp-body { flex: 1; overflow-y: auto; padding: 14px 16px; }
  .lp-customer { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
  .lp-cust-name { font-size: 14px; font-weight: 600; color: #111827; }
  .lp-cust-phone { font-size: 12px; color: #6b7280; margin-top: 2px; display: flex; align-items: center; gap: 4px; }
  .lp-badge { font-size: 10px; font-weight: 500; padding: 2px 10px; border-radius: 9999px; }
  .badge-normal { background: #dbeafe; color: #1d4ed8; }
  .badge-high { background: #fef3c7; color: #92400e; }
  .badge-urgent { background: #fee2e2; color: #dc2626; }
  .lp-info { margin-bottom: 12px; }
  .lp-info-row { display: flex; align-items: flex-start; gap: 8px; font-size: 12px; color: #4b5563; margin-bottom: 7px; line-height: 1.4; }
  .lp-icon { width: 15px; height: 15px; flex-shrink: 0; margin-top: 1px; color: #9ca3af; }
  .lp-divider { border-top: 1px solid #e5e7eb; margin: 12px 0; }
  .lp-form-group { margin-bottom: 12px; }
  .lp-label { font-size: 11px; font-weight: 500; color: #374151; margin-bottom: 4px; display: block; }
  .lp-select { width: 100%; padding: 7px 10px; font-size: 12px; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; color: #374151; }
  .lp-tabs { display: flex; margin-bottom: 5px; border: 1px solid #d1d5db; border-radius: 6px; overflow: hidden; }
  .lp-tab { flex: 1; padding: 5px 10px; font-size: 11px; font-weight: 500; border: none; cursor: pointer; text-align: center; background: #fff; color: #6b7280; }
  .lp-tab.active { background: #f3f4f6; color: #111827; }
  .lp-actions { display: flex; gap: 6px; margin-top: 2px; }
  .lp-action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; padding: 7px 8px; font-size: 11px; font-weight: 500; border: 1px solid #d1d5db; border-radius: 6px; background: #fff; color: #374151; cursor: pointer; }
  .lp-action-btn svg { width: 14px; height: 14px; }
  .lp-action-btn.call { color: #16a34a; border-color: #bbf7d0; }
  .lp-action-btn.call:hover { background: #f0fdf4; }
  .lp-action-btn.nav { color: #2563eb; border-color: #bfdbfe; }
  .lp-action-btn.nav:hover { background: #eff6ff; }
  .lp-action-btn.email { color: #7c3aed; border-color: #ddd6fe; }
  .lp-action-btn.email:hover { background: #f5f3ff; }
  .lp-footer { padding: 10px 16px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; }
  .lp-btn { padding: 8px 14px; font-size: 12px; font-weight: 500; border-radius: 6px; cursor: pointer; border: none; }
  .lp-btn-outline { background: #fff; border: 1px solid #d1d5db; color: #374151; }
  .lp-btn-primary { background: #2563eb; color: #fff; flex: 1; text-align: center; }

  /* ── Right Sidebar ── */
  .job-sidebar { width: 240px; background: #fff; border-left: 1px solid #e5e7eb; overflow-y: auto; flex-shrink: 0; }
  .sidebar-title { padding: 8px 12px; border-bottom: 1px solid #f3f4f6; font-size: 11px; font-weight: 600; color: #374151; display: flex; justify-content: space-between; align-items: center; background: #fff; position: sticky; top: 0; z-index: 2; }
  .sidebar-title-count { font-size: 10px; color: #9ca3af; font-weight: 500; }
  .sidebar-group-header { display: flex; align-items: center; gap: 6px; padding: 5px 12px; background: #fafafa; border-bottom: 1px solid #f3f4f6; }
  .sidebar-color { width: 10px; height: 10px; border-radius: 2px; }
  .sidebar-group-name { font-size: 11px; font-weight: 600; }
  .sidebar-group-members { font-size: 10px; color: #9ca3af; }
  .sidebar-group-count { font-size: 10px; color: #9ca3af; margin-left: auto; }
  .sidebar-job { display: flex; align-items: center; gap: 8px; padding: 7px 12px; border-bottom: 1px solid #f9fafb; cursor: pointer; transition: background 0.1s; }
  .sidebar-job:hover { background: #f9fafb; }
  .sidebar-job.active { background: #eff6ff; border-left: 3px solid #2563eb; }
  .sidebar-job-num { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; font-weight: 700; flex-shrink: 0; }
  .sidebar-job-info { flex: 1; min-width: 0; }
  .sidebar-job-title { font-size: 12px; font-weight: 500; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sidebar-job-addr { font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sidebar-job-time { font-size: 10px; color: #6b7280; white-space: nowrap; }

  /* ── Map Controls ── */
  .map-zoom { position: absolute; bottom: 12px; right: 252px; background: #fff; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.15); overflow: hidden; z-index: 5; }
  .map-zoom button { display: block; width: 32px; height: 32px; border: none; background: #fff; cursor: pointer; font-size: 16px; color: #374151; border-bottom: 1px solid #e5e7eb; }
  .map-zoom button:last-child { border-bottom: none; }
  .map-zoom button:hover { background: #f3f4f6; }
  .map-legend-overlay { position: absolute; bottom: 12px; left: 12px; background: #fff; padding: 6px 10px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.15); font-size: 10px; z-index: 5; transition: left 0.35s cubic-bezier(0.4, 0, 0.2, 1); }
  .map-legend-overlay.shifted { left: 396px; }
  .legend-row { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
  .legend-row:last-child { margin-bottom: 0; }
  .legend-color { width: 8px; height: 8px; border-radius: 50%; }

  /* ── Lightbox ── */
  .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.88); display: none; align-items: center; justify-content: center; z-index: 200; }
  .lightbox.open { display: flex; }
  .lightbox img { max-width: 85%; max-height: 80vh; border-radius: 8px; }
  .lb-close { position: absolute; top: 14px; right: 14px; background: rgba(255,255,255,0.15); border: none; color: #fff; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
  .lb-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.15); border: none; color: #fff; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; }
  .lb-nav.prev { left: 14px; }
  .lb-nav.next { right: 14px; }
  .lb-counter { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.7); font-size: 13px; }
</style>
</head>
<body>
<div class="banner">DESIGN B &mdash; Hover pin = quick preview &bull; Click pin or sidebar = full panel</div>

<!-- Header -->
<div class="header">
  <h1>Dispatch</h1><div class="sep"></div>
  <div class="date-nav"><button>&#8249;</button><button>&#8250;</button><span>Monday, February 9, 2026</span><span class="day-badge">Day</span></div>
  <div class="sep"></div>
  <div class="stat-dots"><div class="stat-dot"><div class="dot" style="background:#ef4444"></div>2</div><div class="stat-dot"><div class="dot" style="background:#3b82f6"></div>4</div><div class="stat-dot"><div class="dot" style="background:#eab308"></div>1</div><div class="stat-dot"><div class="dot" style="background:#22c55e"></div>1</div></div>
  <div class="header-right"><span style="font-size:12px;color:#6b7280">View:</span><button class="view-dropdown">Crew + Map &#9662;</button><button class="icon-btn active" title="Map"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg></button><button class="icon-btn" title="Refresh"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button><button class="add-btn">+ Job</button></div>
</div>

<!-- Timeline -->
<div class="timeline-area">
  <div style="display:flex;height:100%;overflow:hidden">
    <div style="width:150px;flex-shrink:0;overflow-y:auto;border-right:1px solid #e5e7eb">
      <div style="height:28px;background:#fafafa;border-bottom:1px solid #e5e7eb"></div>
      <div class="unassigned-row" style="height:56px;border-bottom:1px solid #fecaca"><div class="unassigned-dot"></div><div style="flex:1"><span class="unassigned-label">Unassigned</span><div class="unassigned-count">2 jobs</div></div></div>
      <div class="tech-row"><div class="tech-avatar" style="background:#2563eb">T1</div><div class="tech-info"><div class="tech-name">Truck 1</div><div class="tech-meta">Adam R. &mdash; 5 jobs</div></div></div>
      <div class="tech-row"><div class="tech-avatar" style="background:#16a34a">T2</div><div class="tech-info"><div class="tech-name">Truck 2</div><div class="tech-meta">John S., Sammy T &mdash; 2 jobs</div></div></div>
    </div>
    <div style="flex:1;overflow-x:auto;overflow-y:auto">
      <div class="time-headers"><div class="time-header">6am</div><div class="time-header">7am</div><div class="time-header">8am</div><div class="time-header">9am</div><div class="time-header">10am</div><div class="time-header">11am</div><div class="time-header">12pm</div><div class="time-header">1pm</div><div class="time-header">2pm</div><div class="time-header">3pm</div><div class="time-header">4pm</div><div class="time-header">5pm</div></div>
      <div style="display:flex;gap:6px;padding:8px;min-width:960px;height:56px;background:#fef2f2;border-bottom:1px solid #fecaca;align-items:center">
        <div class="unassigned-chip" data-job="hvac" onclick="selectJob('hvac')">HVAC Maintenance</div>
        <div class="unassigned-chip" data-job="garage" onclick="selectJob('garage')">Garage Door Fix</div>
      </div>
      <div class="grid-row" style="min-width:960px">
        <div class="job-block" data-job="ac" style="background:#2563eb;left:80px;width:120px" onclick="selectJob('ac')"><span class="job-title">AC Unit Repair</span><span class="job-sub">7:00-8:30am</span></div>
        <div class="job-block" data-job="duct" style="background:#2563eb;left:220px;width:80px" onclick="selectJob('duct')"><span class="job-title">Duct Clean</span><span class="job-sub">8:45-9:45am</span></div>
        <div class="job-block" data-job="filter" style="background:#eab308;left:340px;width:100px" onclick="selectJob('filter')"><span class="job-title">Filter Replace</span><span class="job-sub">10:15-11:30am</span></div>
        <div class="job-block" data-job="thermostat" style="background:#2563eb;left:520px;width:90px" onclick="selectJob('thermostat')"><span class="job-title">Thermostat Install</span><span class="job-sub">12:30-1:45pm</span></div>
        <div class="job-block" data-job="insulation" style="background:#22c55e;left:640px;width:110px" onclick="selectJob('insulation')"><span class="job-title">Insulation Check</span><span class="job-sub">2:00-3:30pm</span></div>
      </div>
      <div class="grid-row" style="min-width:960px">
        <div class="job-block" data-job="electrical" style="background:#16a34a;left:160px;width:100px" onclick="selectJob('electrical')"><span class="job-title">Electrical Insp.</span><span class="job-sub">8:00-9:15am</span></div>
        <div class="job-block" data-job="window" style="background:#16a34a;left:400px;width:120px" onclick="selectJob('window')"><span class="job-title">Window Repair</span><span class="job-sub">11:00-12:30pm</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Status Legend -->
<div class="status-legend">
  <span class="legend-label">Status:</span>
  <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>Unassigned</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div>Scheduled</div>
  <div class="legend-item"><div class="legend-dot" style="background:#eab308"></div>In Progress</div>
  <div class="legend-item"><div class="legend-dot" style="background:#22c55e"></div>Completed</div>
  <div style="margin-left:auto"></div>
  <span class="legend-label">Crews:</span>
  <div class="legend-item"><div class="legend-dot" style="background:#2563eb"></div>Truck 1</div>
  <div class="legend-item"><div class="legend-dot" style="background:#16a34a"></div>Truck 2</div>
</div>

<!-- Drawer Handle -->
<div class="drawer-handle"><div class="handle-bar"></div><span class="handle-label"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg> Map View &bull; 9 jobs</span><div class="handle-bar"></div></div>

<!-- Map + Sidebar -->
<div class="map-drawer"><div class="map-content">
  <div class="map-canvas" id="mapCanvas">
    <svg style="position:absolute;inset:0;width:100%;height:100%;opacity:0.12"><line x1="0" y1="30%" x2="100%" y2="28%" stroke="#888" stroke-width="2"/><line x1="0" y1="60%" x2="100%" y2="62%" stroke="#888" stroke-width="2"/><line x1="25%" y1="0" x2="27%" y2="100%" stroke="#888" stroke-width="2"/><line x1="55%" y1="0" x2="52%" y2="100%" stroke="#888" stroke-width="2"/><line x1="80%" y1="0" x2="78%" y2="100%" stroke="#888" stroke-width="1.5"/><line x1="0" y1="80%" x2="100%" y2="78%" stroke="#888" stroke-width="1"/><line x1="40%" y1="0" x2="38%" y2="100%" stroke="#888" stroke-width="1"/></svg>
    <div class="area-label" style="top:15%;left:32%">SCOTTSDALE</div>
    <div class="area-label" style="top:65%;left:48%">TEMPE</div>
    <div class="area-label" style="top:40%;left:10%">PHOENIX</div>

    <!-- Map Pins -->
    <div class="map-pin" data-job="ac" id="pin-ac" style="top:20%;left:38%;color:#2563eb" onclick="selectJob('ac')" onmouseenter="showCard('ac')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#2563eb"/></svg><span class="pin-num">1</span><div class="pin-tip">AC Unit Repair &mdash; Truck 1</div>
    </div>
    <div class="map-pin" data-job="duct" id="pin-duct" style="top:35%;left:28%;color:#2563eb" onclick="selectJob('duct')" onmouseenter="showCard('duct')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#2563eb"/></svg><span class="pin-num">2</span><div class="pin-tip">Duct Clean &mdash; Truck 1</div>
    </div>
    <div class="map-pin" data-job="filter" id="pin-filter" style="top:48%;left:44%;color:#eab308" onclick="selectJob('filter')" onmouseenter="showCard('filter')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#eab308"/></svg><span class="pin-num">3</span><div class="pin-tip">Filter Replace &mdash; Truck 1</div>
    </div>
    <div class="map-pin" data-job="thermostat" id="pin-thermostat" style="top:28%;left:55%;color:#2563eb" onclick="selectJob('thermostat')" onmouseenter="showCard('thermostat')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#2563eb"/></svg><span class="pin-num">4</span><div class="pin-tip">Thermostat Install &mdash; Truck 1</div>
    </div>
    <div class="map-pin" data-job="insulation" id="pin-insulation" style="top:58%;left:22%;color:#22c55e" onclick="selectJob('insulation')" onmouseenter="showCard('insulation')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#22c55e"/></svg><span class="pin-num">5</span><div class="pin-tip">Insulation Check &mdash; Truck 1</div>
    </div>
    <div class="map-pin" data-job="electrical" id="pin-electrical" style="top:42%;left:60%;color:#16a34a" onclick="selectJob('electrical')" onmouseenter="showCard('electrical')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#16a34a"/></svg><span class="pin-num">1</span><div class="pin-tip">Electrical Insp. &mdash; Truck 2</div>
    </div>
    <div class="map-pin" data-job="window" id="pin-window" style="top:22%;left:68%;color:#16a34a" onclick="selectJob('window')" onmouseenter="showCard('window')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#16a34a"/></svg><span class="pin-num">2</span><div class="pin-tip">Window Repair &mdash; Truck 2</div>
    </div>
    <div class="map-pin" data-job="hvac" id="pin-hvac" style="top:70%;left:35%;color:#6b7280" onclick="selectJob('hvac')" onmouseenter="showCard('hvac')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#6b7280"/></svg><span class="pin-num">?</span><div class="pin-tip">HVAC Maintenance &mdash; Unassigned</div>
    </div>
    <div class="map-pin" data-job="garage" id="pin-garage" style="top:32%;left:72%;color:#6b7280" onclick="selectJob('garage')" onmouseenter="showCard('garage')" onmouseleave="scheduleHideCard()">
      <svg class="pin-svg" viewBox="0 0 28 34"><path d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 20 14 20s14-9.5 14-20C28 6.3 21.7 0 14 0z" fill="#6b7280"/></svg><span class="pin-num">?</span><div class="pin-tip">Garage Door Fix &mdash; Unassigned</div>
    </div>

    <!-- Quick View Popup Card -->
    <div class="popup-card" id="popupCard" onmouseenter="cancelHideCard()" onmouseleave="scheduleHideCard()">
      <div class="popup-photo-strip" id="popupPhotos">
        <img src="" alt="1" /><img src="" alt="2" /><img src="" alt="3" />
      </div>
      <div class="popup-body">
        <div class="popup-title-row">
          <div class="popup-title" id="popupTitle">AC Unit Repair</div>
          <span class="popup-priority" id="popupPriority">Normal</span>
        </div>
        <div class="popup-customer" id="popupCustomer">Adam Richardson &bull; (480) 555-1234</div>
        <div class="popup-meta">
          <div class="popup-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span id="popupTime">7:00 AM</span></div>
          <div class="popup-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg><span id="popupDur">90 min</span></div>
          <div class="popup-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span id="popupAddr">Scottsdale</span></div>
        </div>
        <div class="popup-tags">
          <span class="popup-tag" id="popupStatus" style="background:#dbeafe;color:#1d4ed8;">Scheduled</span>
          <span class="popup-tag" id="popupCrew" style="background:#2563eb;color:#fff;">Truck 1</span>
        </div>
      </div>
      <div class="popup-actions">
        <button class="popup-action action-details" onclick="openPanelFromCard()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>View Details</button>
        <button class="popup-action action-nav"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>Navigate</button>
        <button class="popup-action action-call"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>Call</button>
      </div>
      <div class="popup-arrow" id="popupArrow"></div>
    </div>

    <!-- Left Detail Panel -->
    <div class="left-panel" id="leftPanel">
      <div class="lp-header"><div class="lp-header-content"><h3 id="lp-title">AC Unit Repair</h3><p id="lp-desc">Central AC not cooling properly. Customer reports warm air.</p></div><button class="lp-close" onclick="closePanel()">&#10005;</button></div>
      <div class="lp-carousel"><div class="lp-carousel-inner" id="carouselInner"></div><div class="lp-carousel-label"><svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span id="lp-photo-count">5 photos</span> &mdash; scroll to see more</div></div>
      <div class="lp-body">
        <div class="lp-customer"><div><div class="lp-cust-name" id="lp-customer">Adam Richardson</div><div class="lp-cust-phone"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg><span id="lp-phone">(480) 555-1234</span></div></div><span class="lp-badge badge-normal" id="lp-priority">Normal</span></div>
        <div class="lp-info">
          <div class="lp-info-row"><svg class="lp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span id="lp-address">4521 E Cactus Rd, Scottsdale, AZ 85254</span></div>
          <div class="lp-info-row"><svg class="lp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span id="lp-date">Mon, Feb 9, 2026 at 7:00 AM</span></div>
          <div class="lp-info-row"><svg class="lp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><span id="lp-duration">90 minutes</span></div>
          <div class="lp-info-row"><svg class="lp-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span id="lp-notes">Central AC not cooling. Check refrigerant levels.</span></div>
        </div>
        <div class="lp-divider"></div>
        <div class="lp-form-group"><label class="lp-label">Status</label><select class="lp-select" id="lp-status"><option value="scheduled" selected>Scheduled</option><option value="in_progress">In Progress</option><option value="completed">Completed</option><option value="cancelled">Cancelled</option></select></div>
        <div class="lp-form-group"><label class="lp-label">Assigned Technician</label><div class="lp-tabs"><button class="lp-tab active" onclick="switchTab(this,'individual')">Individual</button><button class="lp-tab" onclick="switchTab(this,'crew')">Crew</button></div><select class="lp-select" id="lp-tech-select"><option>Adam R.</option><option>John Smith</option><option>Jimmy G.</option><option>Sammy T.</option></select><select class="lp-select" id="lp-crew-select" style="display:none"><option>Truck 1 &mdash; Adam R.</option><option>Truck 2 &mdash; John S., Sammy T.</option></select></div>
        <div class="lp-divider"></div>
        <div class="lp-form-group"><label class="lp-label">Quick Actions</label><div class="lp-actions"><button class="lp-action-btn call"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>Call</button><button class="lp-action-btn nav"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>Navigate</button><button class="lp-action-btn email"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email</button></div></div>
      </div>
      <div class="lp-footer"><button class="lp-btn lp-btn-outline" onclick="closePanel()">Close</button><button class="lp-btn lp-btn-primary">View Full Job &#8594;</button></div>
    </div>

    <div class="map-zoom"><button>+</button><button>&#8722;</button></div>
    <div class="map-legend-overlay" id="mapLegend"><div class="legend-row"><div class="legend-color" style="background:#2563eb"></div>Truck 1 (5)</div><div class="legend-row"><div class="legend-color" style="background:#16a34a"></div>Truck 2 (2)</div><div class="legend-row"><div class="legend-color" style="background:#6b7280"></div>Unassigned (2)</div></div>
  </div>

  <!-- Right Sidebar - Always Visible -->
  <div class="job-sidebar">
    <div class="sidebar-title">Today's Jobs (9)<span class="sidebar-title-count">3 crews</span></div>
    <div class="sidebar-group-header"><div class="sidebar-color" style="background:#2563eb"></div><span class="sidebar-group-name" style="color:#2563eb">Truck 1</span><span class="sidebar-group-members">Adam R.</span><span class="sidebar-group-count">5</span></div>
    <div class="sidebar-job" data-job="ac" onclick="selectJob('ac')"><div class="sidebar-job-num" style="background:#2563eb">1</div><div class="sidebar-job-info"><div class="sidebar-job-title">AC Unit Repair</div><div class="sidebar-job-addr">4521 E Cactus Rd, Scottsdale</div></div><div class="sidebar-job-time">7:00</div></div>
    <div class="sidebar-job" data-job="duct" onclick="selectJob('duct')"><div class="sidebar-job-num" style="background:#2563eb">2</div><div class="sidebar-job-info"><div class="sidebar-job-title">Duct Clean</div><div class="sidebar-job-addr">1234 N Hayden Rd, Scottsdale</div></div><div class="sidebar-job-time">8:45</div></div>
    <div class="sidebar-job" data-job="filter" onclick="selectJob('filter')"><div class="sidebar-job-num" style="background:#eab308">3</div><div class="sidebar-job-info"><div class="sidebar-job-title">Filter Replace</div><div class="sidebar-job-addr">789 E Indian School, Phoenix</div></div><div class="sidebar-job-time">10:15</div></div>
    <div class="sidebar-job" data-job="thermostat" onclick="selectJob('thermostat')"><div class="sidebar-job-num" style="background:#2563eb">4</div><div class="sidebar-job-info"><div class="sidebar-job-title">Thermostat Install</div><div class="sidebar-job-addr">2200 E Camelback, Phoenix</div></div><div class="sidebar-job-time">12:30</div></div>
    <div class="sidebar-job" data-job="insulation" onclick="selectJob('insulation')"><div class="sidebar-job-num" style="background:#22c55e">5</div><div class="sidebar-job-info"><div class="sidebar-job-title">Insulation Check</div><div class="sidebar-job-addr">550 W McDowell Rd, Phoenix</div></div><div class="sidebar-job-time">2:00</div></div>
    <div class="sidebar-group-header"><div class="sidebar-color" style="background:#16a34a"></div><span class="sidebar-group-name" style="color:#16a34a">Truck 2</span><span class="sidebar-group-members">John S., Sammy T.</span><span class="sidebar-group-count">2</span></div>
    <div class="sidebar-job" data-job="electrical" onclick="selectJob('electrical')"><div class="sidebar-job-num" style="background:#16a34a">1</div><div class="sidebar-job-info"><div class="sidebar-job-title">Electrical Insp.</div><div class="sidebar-job-addr">555 W Camelback Rd, Phoenix</div></div><div class="sidebar-job-time">8:00</div></div>
    <div class="sidebar-job" data-job="window" onclick="selectJob('window')"><div class="sidebar-job-num" style="background:#16a34a">2</div><div class="sidebar-job-info"><div class="sidebar-job-title">Window Repair</div><div class="sidebar-job-addr">321 E Paradise Ln, Scottsdale</div></div><div class="sidebar-job-time">11:00</div></div>
    <div class="sidebar-group-header"><div class="sidebar-color" style="background:#6b7280"></div><span class="sidebar-group-name" style="color:#6b7280">Unassigned</span><span class="sidebar-group-members"></span><span class="sidebar-group-count">2</span></div>
    <div class="sidebar-job" data-job="hvac" onclick="selectJob('hvac')"><div class="sidebar-job-num" style="background:#6b7280">?</div><div class="sidebar-job-info"><div class="sidebar-job-title">HVAC Maintenance</div><div class="sidebar-job-addr">999 S Mill Ave, Tempe</div></div><div class="sidebar-job-time">TBD</div></div>
    <div class="sidebar-job" data-job="garage" onclick="selectJob('garage')"><div class="sidebar-job-num" style="background:#6b7280">?</div><div class="sidebar-job-info"><div class="sidebar-job-title">Garage Door Fix</div><div class="sidebar-job-addr">1450 N Scottsdale Rd</div></div><div class="sidebar-job-time">TBD</div></div>
  </div>
</div></div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLB()"><button class="lb-close" onclick="closeLB()">&#10005;</button><button class="lb-nav prev" onclick="event.stopPropagation();navLB(-1)">&#8249;</button><img id="lb-img" src="" onclick="event.stopPropagation()"/><button class="lb-nav next" onclick="event.stopPropagation();navLB(1)">&#8250;</button><div class="lb-counter" id="lb-counter"></div></div>

<script>
/* ── Job Data ── */
var J = {
  ac: { t:'AC Unit Repair', d:'Central AC not cooling properly. Customer reports warm air from all vents.', c:'Adam Richardson', ph:'(480) 555-1234', pr:'Normal', pc:'badge-normal', prBg:'#dbeafe', prColor:'#1d4ed8', a:'4521 E Cactus Rd, Scottsdale, AZ 85254', aShort:'Scottsdale', dt:'Mon, Feb 9, 2026 at 7:00 AM', tm:'7:00 AM', du:'90 minutes', duShort:'90 min', n:'Central AC not cooling. Customer reports warm air from all vents. Check refrigerant levels.', s:'scheduled', te:'Adam R.', cr:'Truck 1', crBg:'#2563eb', p:['photo-1585771724684-38269d6639fd','photo-1631545806609-3c480a498e26','photo-1504328345606-18bbc8c9d7d1','photo-1621905252507-b35492cc74b4','photo-1558618666-fcd25c85f82e'] },
  duct: { t:'Duct Clean', d:'Full duct cleaning service for residential HVAC system.', c:'Sarah Mitchell', ph:'(480) 555-2345', pr:'Normal', pc:'badge-normal', prBg:'#dbeafe', prColor:'#1d4ed8', a:'1234 N Hayden Rd, Scottsdale, AZ 85257', aShort:'Scottsdale', dt:'Mon, Feb 9, 2026 at 8:45 AM', tm:'8:45 AM', du:'60 minutes', duShort:'60 min', n:'Annual duct cleaning. Access through garage. Two-story home, 4 vents upstairs.', s:'scheduled', te:'Adam R.', cr:'Truck 1', crBg:'#2563eb', p:['photo-1504328345606-18bbc8c9d7d1','photo-1558618666-fcd25c85f82e','photo-1621905252507-b35492cc74b4'] },
  filter: { t:'Filter Replace', d:'Replace HVAC filters and inspect system performance.', c:'David Chen', ph:'(602) 555-3456', pr:'High', pc:'badge-high', prBg:'#fef3c7', prColor:'#92400e', a:'789 E Indian School Rd, Phoenix, AZ 85014', aShort:'Phoenix', dt:'Mon, Feb 9, 2026 at 10:15 AM', tm:'10:15 AM', du:'75 minutes', duShort:'75 min', n:'Customer requested premium filters. System making unusual noise - investigate.', s:'in_progress', te:'Adam R.', cr:'Truck 1', crBg:'#eab308', p:['photo-1585771724684-38269d6639fd','photo-1631545806609-3c480a498e26'] },
  thermostat: { t:'Thermostat Install', d:'Install new smart thermostat and configure WiFi connection.', c:'Maria Gonzalez', ph:'(602) 555-4567', pr:'Normal', pc:'badge-normal', prBg:'#dbeafe', prColor:'#1d4ed8', a:'2200 E Camelback Rd, Phoenix, AZ 85016', aShort:'Phoenix', dt:'Mon, Feb 9, 2026 at 12:30 PM', tm:'12:30 PM', du:'75 minutes', duShort:'75 min', n:'Ecobee smart thermostat install. Customer has WiFi ready. Old thermostat is Honeywell.', s:'scheduled', te:'Adam R.', cr:'Truck 1', crBg:'#2563eb', p:['photo-1558618666-fcd25c85f82e','photo-1504328345606-18bbc8c9d7d1','photo-1621905252507-b35492cc74b4','photo-1585771724684-38269d6639fd'] },
  insulation: { t:'Insulation Check', d:'Inspect attic insulation and provide efficiency report.', c:'Robert Taylor', ph:'(602) 555-5678', pr:'Normal', pc:'badge-normal', prBg:'#dbeafe', prColor:'#1d4ed8', a:'550 W McDowell Rd, Phoenix, AZ 85003', aShort:'Phoenix', dt:'Mon, Feb 9, 2026 at 2:00 PM', tm:'2:00 PM', du:'90 minutes', duShort:'90 min', n:'Annual insulation inspection. Customer concerned about energy bills. Check for gaps.', s:'completed', te:'Adam R.', cr:'Truck 1', crBg:'#22c55e', p:['photo-1631545806609-3c480a498e26','photo-1585771724684-38269d6639fd'] },
  electrical: { t:'Electrical Inspection', d:'Full electrical panel inspection and safety check.', c:'David Chen', ph:'(602) 555-6789', pr:'High', pc:'badge-high', prBg:'#fef3c7', prColor:'#92400e', a:'555 W Camelback Rd, Phoenix, AZ 85013', aShort:'Phoenix', dt:'Mon, Feb 9, 2026 at 8:00 AM', tm:'8:00 AM', du:'75 minutes', duShort:'75 min', n:'Panel inspection. Customer reported flickering lights. Check breaker connections.', s:'scheduled', te:'John Smith', cr:'Truck 2', crBg:'#16a34a', p:['photo-1504328345606-18bbc8c9d7d1','photo-1621905252507-b35492cc74b4','photo-1558618666-fcd25c85f82e'] },
  window: { t:'Window Repair', d:'Repair broken window seal and replace weather stripping.', c:'Lisa Park', ph:'(480) 555-7890', pr:'Urgent', pc:'badge-urgent', prBg:'#fee2e2', prColor:'#dc2626', a:'321 E Paradise Ln, Scottsdale, AZ 85260', aShort:'Scottsdale', dt:'Mon, Feb 9, 2026 at 11:00 AM', tm:'11:00 AM', du:'90 minutes', duShort:'90 min', n:'Broken seal on master bedroom window. Drafty air. Weather stripping worn.', s:'scheduled', te:'John Smith', cr:'Truck 2', crBg:'#16a34a', p:['photo-1585771724684-38269d6639fd','photo-1631545806609-3c480a498e26','photo-1504328345606-18bbc8c9d7d1','photo-1558618666-fcd25c85f82e'] },
  hvac: { t:'HVAC Maintenance', d:'Routine HVAC maintenance and tune-up service.', c:'James Thompson', ph:'(480) 555-8901', pr:'Normal', pc:'badge-normal', prBg:'#dbeafe', prColor:'#1d4ed8', a:'999 S Mill Ave, Tempe, AZ 85281', aShort:'Tempe', dt:'Mon, Feb 9, 2026 \u2014 Time TBD', tm:'TBD', du:'60 minutes', duShort:'60 min', n:'Standard maintenance. Returning client. Last service 6 months ago.', s:'scheduled', te:'Unassigned', cr:'Unassigned', crBg:'#6b7280', p:['photo-1621905252507-b35492cc74b4','photo-1585771724684-38269d6639fd'] },
  garage: { t:'Garage Door Fix', d:'Garage door opener malfunction and track alignment.', c:'Jennifer Adams', ph:'(480) 555-9012', pr:'Urgent', pc:'badge-urgent', prBg:'#fee2e2', prColor:'#dc2626', a:'1450 N Scottsdale Rd, Scottsdale, AZ 85257', aShort:'Scottsdale', dt:'Mon, Feb 9, 2026 \u2014 Time TBD', tm:'TBD', du:'120 minutes', duShort:'120 min', n:'Garage door stuck halfway. Motor running but door not moving. Possible track issue.', s:'scheduled', te:'Unassigned', cr:'Unassigned', crBg:'#6b7280', p:['photo-1558618666-fcd25c85f82e'] }
};

var U = 'https://images.unsplash.com/';
var cId = null;            // currently selected job id (panel)
var cPhotos = [];          // current lightbox photos
var cPhoto = 0;            // current lightbox index
var pOpen = false;         // is left panel open?
var cardOpen = false;      // is popup card visible?
var cardJobId = null;      // job shown in popup card
var hideCardTimer = null;  // timer for delayed card hide

/* ── Status colors for popup card ── */
var statusMap = {
  scheduled: { bg: '#dbeafe', color: '#1d4ed8', label: 'Scheduled' },
  in_progress: { bg: '#fef3c7', color: '#92400e', label: 'In Progress' },
  completed: { bg: '#dcfce7', color: '#16a34a', label: 'Completed' },
  cancelled: { bg: '#f3f4f6', color: '#6b7280', label: 'Cancelled' }
};

/* ── Highlight helpers ── */
function clearAllHighlights() {
  document.querySelectorAll('.map-pin').forEach(function(p) { p.classList.remove('selected'); });
  document.querySelectorAll('.sidebar-job').forEach(function(s) { s.classList.remove('active'); });
  document.querySelectorAll('.job-block').forEach(function(b) { b.classList.remove('selected'); });
  document.querySelectorAll('.unassigned-chip').forEach(function(c) { c.classList.remove('selected'); });
}

function highlightJob(id) {
  var pin = document.getElementById('pin-' + id);
  if (pin) pin.classList.add('selected');
  document.querySelectorAll('.sidebar-job[data-job="' + id + '"]').forEach(function(e) { e.classList.add('active'); });
  document.querySelectorAll('.job-block[data-job="' + id + '"]').forEach(function(e) { e.classList.add('selected'); });
  document.querySelectorAll('.unassigned-chip[data-job="' + id + '"]').forEach(function(e) { e.classList.add('selected'); });
}

/* ══════════════════════════════════════════
   HOVER = Quick View Card (auto-shows)
   ══════════════════════════════════════════ */
function showCard(id) {
  cancelHideCard();
  var j = J[id];
  if (!j) return;

  // If already showing this card, just keep it
  if (cardOpen && cardJobId === id) return;

  cardJobId = id;

  // Highlight this pin + sidebar (keep panel job highlighted too)
  if (pOpen) {
    // Clear only non-panel highlights, then highlight both panel job + hovered job
    clearAllHighlights();
    highlightJob(cId);
    if (id !== cId) highlightJob(id);
  } else {
    clearAllHighlights();
    highlightJob(id);
  }

  // Populate card content
  document.getElementById('popupTitle').textContent = j.t;
  document.getElementById('popupCustomer').innerHTML = j.c + ' &bull; ' + j.ph;
  document.getElementById('popupTime').textContent = j.tm;
  document.getElementById('popupDur').textContent = j.duShort;
  document.getElementById('popupAddr').textContent = j.aShort;

  var st = statusMap[j.s] || statusMap.scheduled;
  var statusEl = document.getElementById('popupStatus');
  statusEl.textContent = st.label;
  statusEl.style.background = st.bg;
  statusEl.style.color = st.color;

  var crewEl = document.getElementById('popupCrew');
  crewEl.textContent = j.cr;
  crewEl.style.background = j.crBg;
  crewEl.style.color = '#fff';

  var prEl = document.getElementById('popupPriority');
  prEl.textContent = j.pr;
  prEl.style.background = j.prBg;
  prEl.style.color = j.prColor;

  // Populate photo strip (up to 3)
  var strip = document.getElementById('popupPhotos');
  strip.innerHTML = '';
  var photos = j.p.slice(0, 3);
  if (photos.length === 0) {
    strip.style.display = 'none';
  } else {
    strip.style.display = 'flex';
    photos.forEach(function(ph) {
      var img = document.createElement('img');
      img.src = U + ph + '?w=200&h=100&fit=crop';
      img.alt = '';
      strip.appendChild(img);
    });
  }

  // Position card above the pin
  var card = document.getElementById('popupCard');
  var arrow = document.getElementById('popupArrow');
  var mapRect = document.getElementById('mapCanvas').getBoundingClientRect();
  var pin = document.getElementById('pin-' + id);
  var pinRect = pin.getBoundingClientRect();

  var cardWidth = 310;
  var cardHeight = photos.length > 0 ? 260 : 190;
  var left = (pinRect.left - mapRect.left) + (pinRect.width / 2) - (cardWidth / 2);
  var top = (pinRect.top - mapRect.top) - cardHeight - 12;

  // Clamp horizontal
  if (left < 10) left = 10;
  if (left + cardWidth > mapRect.width - 10) left = mapRect.width - cardWidth - 10;

  // If not enough room above, show below pin
  arrow.className = 'popup-arrow';
  if (top < 10) {
    top = (pinRect.top - mapRect.top) + pinRect.height + 10;
    arrow.classList.add('top');
  }

  card.style.left = left + 'px';
  card.style.top = top + 'px';
  card.classList.add('open');
  cardOpen = true;
}

function scheduleHideCard() {
  // Small delay so user can move mouse from pin to card
  hideCardTimer = setTimeout(function() {
    document.getElementById('popupCard').classList.remove('open');
    if (pOpen) {
      // Restore only the panel job's highlight
      clearAllHighlights();
      highlightJob(cId);
    } else {
      clearAllHighlights();
    }
    cardOpen = false;
    cardJobId = null;
  }, 300);
}

function cancelHideCard() {
  if (hideCardTimer) { clearTimeout(hideCardTimer); hideCardTimer = null; }
}

function hideCardNow() {
  cancelHideCard();
  document.getElementById('popupCard').classList.remove('open');
  cardOpen = false;
  cardJobId = null;
}

/* ══════════════════════════════════════════
   CLICK = Open Full Left Panel
   ══════════════════════════════════════════ */

/* From card's "View Details" button */
function openPanelFromCard() {
  var id = cardJobId;
  hideCardNow();
  if (id) openPanel(id);
}

/* From pin click, sidebar click, or timeline click */
function selectJob(id) {
  hideCardNow();
  clearAllHighlights();
  highlightJob(id);
  openPanel(id);
}

function openPanel(id) {
  var j = J[id];
  if (!j) return;
  cId = id;
  cPhotos = j.p.map(function(x) { return U + x + '?w=900&h=700&fit=crop'; });
  cPhoto = 0;

  clearAllHighlights();
  highlightJob(id);

  // Update panel content
  document.getElementById('lp-title').textContent = j.t;
  document.getElementById('lp-desc').textContent = j.d;
  document.getElementById('lp-customer').textContent = j.c;
  document.getElementById('lp-phone').textContent = j.ph;
  document.getElementById('lp-address').textContent = j.a;
  document.getElementById('lp-date').textContent = j.dt;
  document.getElementById('lp-duration').textContent = j.du;
  document.getElementById('lp-notes').textContent = j.n;
  document.getElementById('lp-status').value = j.s;
  document.getElementById('lp-photo-count').textContent = j.p.length + ' photo' + (j.p.length !== 1 ? 's' : '');

  var b = document.getElementById('lp-priority');
  b.textContent = j.pr;
  b.className = 'lp-badge ' + j.pc;

  var ts = document.getElementById('lp-tech-select');
  for (var i = 0; i < ts.options.length; i++) { if (ts.options[i].text === j.te) { ts.selectedIndex = i; break; } }
  var cs = document.getElementById('lp-crew-select');
  for (var i = 0; i < cs.options.length; i++) { if (cs.options[i].text.indexOf(j.cr) === 0) { cs.selectedIndex = i; break; } }

  // Build carousel
  var ci = document.getElementById('carouselInner');
  ci.innerHTML = '';
  j.p.forEach(function(ph, idx) {
    var d = document.createElement('div');
    d.className = 'lp-carousel-thumb';
    d.onclick = function() { openLB(idx); };
    d.innerHTML = '<img src="' + U + ph + '?w=200&h=150&fit=crop" alt="' + (idx + 1) + '"/><div class="carousel-zoom"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></div>';
    ci.appendChild(d);
  });

  document.getElementById('leftPanel').classList.add('open');
  document.getElementById('mapLegend').classList.add('shifted');
  pOpen = true;
}

function closePanel() {
  document.getElementById('leftPanel').classList.remove('open');
  document.getElementById('mapLegend').classList.remove('shifted');
  clearAllHighlights();
  pOpen = false;
  cId = null;
}

/* ── Tab switch ── */
function switchTab(btn, mode) {
  document.querySelectorAll('.lp-tab').forEach(function(t) { t.classList.remove('active'); });
  btn.classList.add('active');
  document.getElementById('lp-tech-select').style.display = mode === 'individual' ? '' : 'none';
  document.getElementById('lp-crew-select').style.display = mode === 'crew' ? '' : 'none';
}

/* ── Lightbox ── */
function openLB(i) { cPhoto = i; document.getElementById('lb-img').src = cPhotos[i]; document.getElementById('lb-counter').textContent = (i + 1) + ' / ' + cPhotos.length; document.getElementById('lightbox').classList.add('open'); }
function closeLB() { document.getElementById('lightbox').classList.remove('open'); }
function navLB(d) { cPhoto = (cPhoto + d + cPhotos.length) % cPhotos.length; document.getElementById('lb-img').src = cPhotos[cPhoto]; document.getElementById('lb-counter').textContent = (cPhoto + 1) + ' / ' + cPhotos.length; }

/* ── Map background click: dismiss card/panel ── */
document.getElementById('mapCanvas').addEventListener('click', function(e) {
  // Don't dismiss if clicking on a pin, the popup card, or the left panel
  if (e.target.closest('.map-pin') || e.target.closest('.popup-card') || e.target.closest('.left-panel')) return;
  if (cardOpen) { hideCardNow(); clearAllHighlights(); }
  else if (pOpen) closePanel();
});

/* ── Keyboard shortcuts ── */
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('lightbox').classList.contains('open')) { closeLB(); return; }
    if (cardOpen) { hideCardNow(); clearAllHighlights(); return; }
    if (pOpen) { closePanel(); return; }
  }
  if (document.getElementById('lightbox').classList.contains('open')) {
    if (e.key === 'ArrowLeft') navLB(-1);
    if (e.key === 'ArrowRight') navLB(1);
  }
});
</script>
</body>
</html>